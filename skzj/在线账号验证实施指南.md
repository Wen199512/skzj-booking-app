# ?? GitHub 在线账号验证 - 完整实施指南

## ?? 已完成的工作

### ? 代码修改

1. **创建 `OnlineAccountService.cs`**
   - 从 GitHub 下载 zh.txt
   - 混合模式：优先在线，失败则使用本地
   - 路径：`skzj/Services/OnlineAccountService.cs`

2. **修改 `LoginPage.xaml.cs`**
   - 使用 OnlineAccountService 加载账号
   - 显示"在线"或"离线"状态
   - 完全向后兼容

3. **更新 `.gitignore`**
   - 确保 zh.txt 被提交到 GitHub

4. **创建上传脚本**
   - `upload-zh-to-github.bat` - 快速上传 zh.txt

5. **网络权限已配置**
   - `AndroidManifest.xml` 已包含 INTERNET 权限

---

## ?? 实施步骤

### 步骤 1: 上传 zh.txt 到 GitHub

#### 方法 A: 使用 GitHub Desktop（推荐）

1. **打开 GitHub Desktop**

2. **检查更改**
   - 应该看到以下文件：
     - `skzj/zh.txt`
     - `skzj/Services/OnlineAccountService.cs`
     - `skzj/LoginPage.xaml.cs`
     - `.gitignore`

3. **提交更改**
   - 输入提交信息：`添加在线账号验证功能`
   - 点击 "Commit to main"

4. **推送到 GitHub**
   - 点击 "Push origin"
   - 等待上传完成

#### 方法 B: 使用脚本

```cmd
cd C:\Users\14564\source\repos\skzj\skzj
upload-zh-to-github.bat
```

---

### 步骤 2: 获取 GitHub Raw URL

1. **访问您的仓库**
   ```
   https://github.com/Wen199512/skzj-booking-app
   ```

2. **找到 zh.txt**
   - 点击 `skzj` 文件夹
   - 点击 `zh.txt` 文件

3. **点击 "Raw" 按钮**
   - 在文件查看页面右上角

4. **复制 URL**
   - 应该是这样的格式：
     ```
     https://raw.githubusercontent.com/Wen199512/skzj-booking-app/main/skzj/zh.txt
     ```

5. **验证 URL**
   - 在浏览器中打开这个 URL
   - 应该能看到 zh.txt 的内容

---

### 步骤 3: 更新代码中的 URL

打开 `skzj/Services/OnlineAccountService.cs`，找到第9行：

```csharp
private const string GitHubRawUrl = "https://raw.githubusercontent.com/Wen199512/skzj-booking-app/main/skzj/zh.txt";
```

确认这个 URL 是正确的（应该已经是您的仓库地址）。

---

### 步骤 4: 构建 APK

```cmd
cd C:\Users\14564\source\repos\skzj\skzj
clean-build-publish.bat
```

或使用 Visual Studio 构建。

---

### 步骤 5: 测试 APK

1. **安装 APK 到手机**

2. **打开应用**
   - 观察状态显示

3. **检查连接状态**
   - **成功**：显示 "已连接 (在线 X 个账号)"（绿色）
   - **失败**：显示 "已连接 (离线 X 个账号)"（橙色）

4. **测试登录**
   - 使用 zh.txt 中的账号登录

---

## ?? 以后如何更新账号

### 添加新账号（超简单！）

1. **在本地修改 zh.txt**
   ```
   打开：C:\Users\14564\source\repos\skzj\skzj\zh.txt
   
   添加新行：
   新用户,1234,ABCD1234EFGH5678...,PASSWORD123...
   ```

2. **在 GitHub Desktop 中**
   - 会自动检测到 zh.txt 变更
   - 输入提交信息："添加新用户"
   - 点击 "Commit to main"
   - 点击 "Push origin"

3. **完成！**
   - GitHub 上的 zh.txt 已更新
   - 所有用户下次打开 APP 自动获取新账号
   - **无需重新发布 APK！**

---

## ?? 工作原理

### APP 启动流程

```
用户打开 APP
    ↓
显示"正在连接服务器..."
    ↓
尝试从 GitHub 下载 zh.txt
    ↓
┌─────────────┬─────────────┐
│   成功      │   失败      │
├─────────────┼─────────────┤
│ 解析账号    │ 使用本地    │
│ 显示"在线"  │ 显示"离线"  │
│ (绿色)      │ (橙色)      │
└─────────────┴─────────────┘
    ↓
用户可以登录
```

---

## ?? 状态说明

### 状态显示

| 状态 | 颜色 | 说明 |
|------|------|------|
| **已连接 (在线 X 个账号)** | ?? 绿色 | 从 GitHub 成功加载 |
| **已连接 (离线 X 个账号)** | ?? 橙色 | 使用内嵌备用文件 |
| **连接失败** | ?? 红色 | 完全失败 |
| **正在连接服务器...** | ?? 橙色 | 正在加载中 |

---

## ?? 故障排查

### 问题 1: 始终显示"离线"

**可能原因**：
- GitHub URL 不正确
- zh.txt 未上传到 GitHub
- 没有网络连接
- GitHub 仓库是 Private 且未配置 Token

**解决方法**：

1. **检查 URL**
   ```
   在浏览器中打开:
   https://raw.githubusercontent.com/Wen199512/skzj-booking-app/main/skzj/zh.txt
   
   应该能看到文件内容
   ```

2. **检查 GitHub 仓库**
   ```
   访问: https://github.com/Wen199512/skzj-booking-app
   确认 skzj/zh.txt 文件存在
   ```

3. **查看 APK 日志**
   - 连接手机到电脑
   - 使用 Android Studio 查看 Logcat
   - 搜索："GitHub" 或 "账号"

---

### 问题 2: 显示"连接失败"（红色）

**原因**：在线和本地都失败了

**解决方法**：
1. 确保 zh.txt 在项目中
2. 确保 zh.txt 设置为 EmbeddedResource
3. 重新构建 APK

---

### 问题 3: Private 仓库无法访问

如果仓库设置为 Private，需要使用 Personal Access Token。

**修改 OnlineAccountService.cs**：

```csharp
public OnlineAccountService()
{
    _httpClient = new HttpClient
    {
        Timeout = TimeSpan.FromSeconds(10)
    };
    
    // 添加 GitHub Token
    _httpClient.DefaultRequestHeaders.Authorization = 
        new System.Net.Http.Headers.AuthenticationHeaderValue(
            "Bearer", 
            "ghp_your_token_here"  // 替换为您的 Token
        );
    
    _httpClient.DefaultRequestHeaders.UserAgent.ParseAdd("SKZJ-Booking-App/1.0");
    
    _bookingService = new BookingService();
}
```

**获取 Token**：
1. 访问：https://github.com/settings/tokens
2. Generate new token → classic
3. 勾选 `repo` 权限
4. 生成并复制 Token
5. 替换代码中的 `ghp_your_token_here`

---

## ?? 用户体验

### 场景 1: 正常使用（有网络）

```
打开 APP
↓
2-3 秒加载
↓
显示"已连接 (在线 14 个账号)" ??
↓
输入姓名和验证码
↓
登录成功
```

### 场景 2: 无网络

```
打开 APP
↓
尝试连接 GitHub（10秒超时）
↓
显示"已连接 (离线 14 个账号)" ??
↓
仍可正常登录
```

---

## ?? 安全建议

### 如果使用 Public 仓库

**优点**：
- ? 无需 Token
- ? 简单直接

**缺点**：
- ?? 任何人都能看到 zh.txt
- ?? 账号信息公开

**建议**：
- 如果账号不包含敏感信息，可以使用
- 或者加密 zh.txt 内容

### 如果使用 Private 仓库（推荐）

**优点**：
- ? 账号信息安全
- ? 只有授权用户能访问

**缺点**：
- ?? 需要配置 Token
- ?? Token 会被打包在 APK 中

**建议**：
- 使用 Private 仓库
- Token 只给 `repo` 读取权限
- 定期更换 Token

---

## ?? 方案对比

| 特性 | 嵌入式 | 在线（当前方案） |
|------|--------|------------------|
| **更新便利** | ? 需要发布新版 | ? 随时更新 |
| **离线可用** | ? 完全离线 | ? 有备用 |
| **用户体验** | ??? | ????? |
| **管理便利** | ?? | ????? |

---

## ? 实施清单

### 开发阶段

- [x] 创建 OnlineAccountService.cs
- [x] 修改 LoginPage.xaml.cs
- [x] 更新 .gitignore
- [x] 配置网络权限
- [x] 创建上传脚本

### 部署阶段

- [ ] 上传 zh.txt 到 GitHub
- [ ] 获取 GitHub Raw URL
- [ ] 验证 URL 可访问
- [ ] 构建新 APK
- [ ] 测试在线加载
- [ ] 测试离线模式
- [ ] 发布 APK

### 使用阶段

- [ ] 教用户如何更新账号
- [ ] 监控使用情况
- [ ] 收集反馈

---

## ?? 优势总结

### 对管理员

1. ? **极其方便** - 只需修改 GitHub 文件
2. ? **无需重新发布** - 修改后立即生效
3. ? **版本控制** - GitHub 自动记录历史
4. ? **多人协作** - 可以多人管理账号
5. ? **回滚容易** - Git 可以回滚到任意版本

### 对用户

1. ? **自动更新** - 无需下载新版本
2. ? **始终最新** - 总是使用最新账号列表
3. ? **离线可用** - 没网也能用
4. ? **体验流畅** - 加载速度快

---

## ?? 技术支持

### 查看日志

如需排查问题，查看 APP 日志：

```
连接手机到电脑
↓
打开 Android Studio
↓
Logcat 窗口
↓
过滤: "GitHub" 或 "账号"
```

### 常见日志

**成功：**
```
? 从 GitHub 成功加载 14 个账号
```

**失败然后使用本地：**
```
?? 从 GitHub 加载失败，尝试使用本地文件: ...
? 从本地备用文件加载 14 个账号
```

**完全失败：**
```
? 无法加载账号文件
```

---

## ?? 总结

通过这个方案，您现在可以：

1. **随时更新账号** - 修改 GitHub 文件即可
2. **无需发布新版** - 所有用户自动更新
3. **保留离线功能** - 无网络时仍可使用
4. **集中管理** - 通过 GitHub 管理所有账号

**这是账号管理的最佳实践！** ??

---

**下一步：运行 `upload-zh-to-github.bat` 开始实施！**
